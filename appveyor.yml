image: Visual Studio 2017
configuration: Release

platform:
  - amd64
  - x86

install:
  ## Download nasm
  - mkdir nasm
  - cd nasm
  - appveyor DownloadFile https://www.nasm.us/pub/nasm/releasebuilds/2.14.02/win64/nasm-2.14.02-win64.zip -FileName nasm.zip
  - 7z e -y nasm.zip
  - set PATH=%PATH%;%CD%
  - cd ..

  ## Download zlib
  - mkdir zlib
  - cd zlib
  - appveyor DownloadFile https://downloads.sourceforge.net/project/gnuwin32/zlib/1.2.3/zlib-1.2.3-bin.zip -FileName zlib.zip
  - 7z e -y zlib.zip
  - set ZLIB=%CD%
  - cd ..

  ## Download libpng
  - mkdir libpng
  - cd libpng
  - if "%platform%"=="amd64" (
  appveyor DownloadFile https://ci.appveyor.com/api/buildjobs/v2b5h2epxonk19li/artifacts/libpng.7z -FileName libpng.7z
) else (
  appveyor DownloadFile https://ci.appveyor.com/api/buildjobs/061luddsh9mluyr0/artifacts/libpng.7z -FileName libpng.7z
)
  - 7z e -y libpng.zip
  - set PNGLIB=%CD%

  ## Prepare cmake
  - cd %APPVEYOR_BUILD_FOLDER%
  - mkdir cmake_build

before_build:
  - cmake --version
  - cd cmake_build
  - if "%platform%"=="amd64" (
  cmake .. -G "Visual Studio 15 2017" -A x64 -T host=x64 -DZLIB_LIBRARY="%ZLIB%/bin/zlib1.dll" -DZLIB_INCLUDE_DIR="%ZLIB%/include" -DPNG_LIBRARY="%PNGLIB%/bin/libpng12.dll" -DPNG_PNG_INCLUDE_DIR="%PNGLIB%/include"
) else (
  cmake .. -G "Visual Studio 15 2017" -DZLIB_LIBRARY="%ZLIB%/bin/zlib1.dll" -DZLIB_INCLUDE_DIR="%ZLIB%/include" -DPNG_LIBRARY="%PNGLIB%/bin/libpng12.dll" -DPNG_PNG_INCLUDE_DIR="%PNGLIB%/include"
)

build_script: 
  - cd %APPVEYOR_BUILD_FOLDER%
  - msbuild cmake_build\mozjpeg.sln

artifacts:
 - path: cmake_build\**\Release\**\*.exe
 - path: cmake_build\**\Release\**\*.dll
 - path: cmake_build\**\Release\**\*.lib
